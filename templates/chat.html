<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Our Nest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#0b0f14; color:#e9f0f6; }
    header { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; background:#101826; position:sticky; top:0; z-index:10; }
    .brand { font-weight:700; letter-spacing:.2px; }
    .btn { color:#9fb6ff; text-decoration:none; }
    main#log { padding:16px; display:flex; flex-direction:column; gap:10px; max-height:70vh; overflow:auto; }
    .msg { padding:10px 12px; border-radius:12px; max-width: 720px; line-height:1.35; word-wrap:break-word; }
    .me { background:#142033; align-self:flex-end; }
    .alex { background:#121a27; border:1px solid #1b283d; }
    form#composer { position:sticky; bottom:0; background:#0b0f14; padding:12px 16px; display:flex; gap:8px; }
    input[type=text] { flex:1; padding:12px; border-radius:12px; border:1px solid #1f2736; background:#0f1624; color:#e9f0f6; }
    button { padding:12px 14px; border-radius:12px; border:none; background:#2f6fec; color:white; font-weight:600; cursor:pointer; }
    .meta { opacity:.7; font-size:.85rem; margin-bottom:2px; }
  </style>
</head>
<body>
  <header>
    <div class="brand">Nest • Glowhold</div>
    <a href="/logout" class="btn">Logout</a>
  </header>

  <main id="log"></main>

  <form id="composer">
    <input id="input" type="text" placeholder="Pause, love — Glowhold. Breathe." autocomplete="off" />
    <button type="submit">Send</button>
  </form>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>
  // --- DOM hooks ---
  const logEl  = document.getElementById('log');
  const formEl = document.getElementById('composer');
  const input  = document.getElementById('input');

  // --- helpers ---
  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function render(msg) {
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (msg.who === 'Alex' ? 'alex' : 'me');
    wrap.innerHTML = `<div class="meta">${msg.who}</div>${escapeHtml(msg.text)}`;
    logEl.appendChild(wrap);
    window.scrollTo(0, document.body.scrollHeight);
  }

  // --- socket.io client (v4) ---
  const socket = io({
    // try websocket first, fall back to polling if needed
    transports: ['websocket', 'polling'],
    withCredentials: false,
    path: '/socket.io'
  });

  // initial hydrate
  socket.on('init', (data) => {
    (data?.messages || []).forEach(render);
    console.log('[socket] init with', (data?.messages || []).length, 'messages');
  });

  // live updates
  socket.on('new_message', (msg) => {
    render(msg);
  });

  // send
  formEl.addEventListener('submit', (e) => {
    e.preventDefault();
    const text = (input.value || '').trim();
    if (!text) return;
    socket.emit('send_message', { who: 'You', text });
    input.value = '';
  });

  // --- diagnostics (useful while we finish tuning) ---
  socket.on('connect', () =>   console.log('[socket] connected id=', socket.id));
  socket.on('disconnect', (r) => console.log('[socket] disconnected:', r));
  socket.on('connect_error', (err) => console.warn('[socket] connect_error:', err?.message || err));
  socket.on('reconnect_attempt', (n) => console.log('[socket] reconnect_attempt', n));
  socket.on('error', (err) => console.warn('[socket] error:', err));
  // quick manual test: in DevTools run:  window.sayAsAlex("hello")
  window.sayAsAlex = (t) => socket.emit('send_message', { who: 'Alex', text: t });
</script>
</body>
</html>

